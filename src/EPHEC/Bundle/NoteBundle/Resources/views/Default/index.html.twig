{% extends "base.html.twig" %}
{% block scriptgmap %}

    <style>
        #map {
            width: 600px;
            height: 600px;
            float: left;
        }
        #infoPanel {
            float: left;
            margin-left: 10px;
        }
        #tabNote {
            float: left;
            margin-left: 10px;
        }
        #infoPanel div {
            margin-bottom: 5px;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script>
        // https://developers.google.com/maps/documentation/javascript/examples/map-geolocation
        var geocoder = new google.maps.Geocoder();
        var map;

        function geocodePositionTab(pos,callback) {
            geocoder.geocode({
                latLng: pos
            }, function(responses) {
                if (responses && responses.length > 0) {
                    callback(responses[0].formatted_address);
                } else {
                    callback('Cannot determine address at this location.');
                }
            });
        }
        function geocodePosition(pos) {
            geocoder.geocode({
                latLng: pos
            }, function(responses) {
                if (responses && responses.length > 0) {
                    updateMarkerAddress(responses[0].formatted_address);
                } else {
                    updateMarkerAddress('Cannot determine address at this location.');
                }
            });
        }

        function updateMarkerStatus(str) {
            document.getElementById('markerStatus').innerHTML = str;
        }

        function updateMarkerPosition(latLng) {
            document.getElementById('info').innerHTML = [
                latLng.lat(),
                latLng.lng()
            ].join(', ');
        }

        function updateMarkerAddress(str) {
            document.getElementById('address').innerHTML = str;
        }
        //var map;
        function initialize() {
            var latLng = new google.maps.LatLng(50.8504500, 4.3487800);
            map = new google.maps.Map(document.getElementById('map'), {
                center: latLng,
                zoom: 8
            });
            var infoWindow = new google.maps.InfoWindow({map: map});
            var personnalMarker;
            // Try HTML5 geolocation.
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    infoWindow.setPosition(pos);
                    infoWindow.setContent('Location found.');
                    map.setCenter(pos);
                    personnalMarker.setPosition(pos);
                    personnalMarker.setVisible(true);
                    updateMarkerPosition(map.getCenter());
                    geocodePosition(map.getCenter());
                }, function() {
                    handleLocationError(true, infoWindow, map.getCenter());
                });
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, infoWindow, map.getCenter());
                personnalMarker.setVisible(true);
                updateMarkerPosition(map.getCenter());
                geocodePosition(map.getCenter());
            }
           /* var marker = new google.maps.Marker({
                position: latlng,
                map: map,
                title: 'Set lat/lon values for this property',
                draggable: true
            });*/
            /*var marker = new google.maps.Marker({
                position: {lat: 50.8504500, lng: 4.3487800},
                map: map,
                animation:google.maps.Animation.DROP,
                icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                title: 'Rendez-vous chez le dentiste!'
            });
            var marker = new google.maps.Marker({
                position: {lat: 50.541441396370274, lng: 4.856913942187475},
                map: map,
                animation:google.maps.Animation.DROP,
                icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                title: 'Rendez-vous chez le médecin!'
            });
            var marker = new google.maps.Marker({
                position: {lat: 50.7608912624449, lng: 4.758136789062519},
                map: map,
                animation:google.maps.Animation.DROP,
                icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                title: 'Rendez-vous avec la mère de Nico à 18H45!'
            });*/
            personnalMarker = new google.maps.Marker({
                position: map.getCenter(),
                map: map,
                draggable: true,
                title: 'Ajouter un mémo',
                icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                visible: false
            });
            // Update current position info.

            // Add dragging event listeners.
            google.maps.event.addListener(personnalMarker, 'dragstart', function() {
                updateMarkerAddress('Dragging...');
            });

            google.maps.event.addListener(personnalMarker, 'drag', function() {
                updateMarkerStatus('Dragging...');
                updateMarkerPosition(personnalMarker.getPosition());
            });

            google.maps.event.addListener(personnalMarker, 'dragend', function() {
                updateMarkerStatus('Drag ended');
                geocodePosition(personnalMarker.getPosition());
            });
            showNote();
            createTable();

        }
        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            infoWindow.setPosition(pos);
            infoWindow.setContent(browserHasGeolocation ?
                    'Error: The Geolocation service failed.' :
                    'Error: Your browser doesn\'t support geolocation.');
        }

        google.maps.event.addDomListener(window, 'load', initialize);
        function showNote() {
            var tab = {{ note | raw }};
            $.each(tab, function (i, item) {
                var marker = new google.maps.Marker({
                    position: {lat: item.lat, lng: item.long},
                    map: map,
                    animation: google.maps.Animation.DROP,
                    icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                    title: item.desc
                });
                //console.log(item.desc)
            });
        }
        function createTable(){
            var tab = {{ note | raw }};
            $.each(tab, function (i, item) {
                var callback;
                geocodePositionTab(new google.maps.LatLng(item.lat,item.long),function(callback){
                    document.getElementById('tableNote').innerHTML += '<tr><td>'+item.desc+'</td><td>'+item.date+'</td><td>'+ callback +'</td></tr>'
                });
            });

        }
    </script>
{% endblock %}
{% block content %}
    <h3>Vos mémos</h3>
    <div id="map"></div>
    <div id="infoPanel">
        <b>Marker status:</b>
        <div id="markerStatus"><i>Click and drag the marker.</i></div>
        <b>Current position:</b>
        <div id="info"></div>
        <b>Closest matching address:</b>
        <div id="address"></div>
    </div>
    <div id="tabNote"><table id="tableNote" class="table table-striped table-hover "></table> </div>
{% endblock %}

{#Hello {{ name }}!#}
